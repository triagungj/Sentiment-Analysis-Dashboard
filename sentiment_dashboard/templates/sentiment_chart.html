<!DOCTYPE html>
<html>
  <head>
    <title>Sentiment Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .month-filter {
        margin-bottom: 20px;
      }
      .month-filter button {
        margin-right: 8px;
        padding: 6px 16px;
        font-size: 15px;
        border-radius: 4px;
        border: 1px solid #ccc;
        background: #f8f9fa;
        cursor: pointer;
      }
      .month-filter button.active {
        background: #007bff;
        color: #fff;
        border-color: #007bff;
      }
      .chart-container {
        overflow-x: auto;
        width: 100%;
      }
      #sentimentChart {
        height: 400px;
      }
    </style>
  </head>
  <body>
    <h2>Sentiment Statistics Per Month</h2>
    <div class="month-filter" id="monthFilter"></div>
    <div class="chart-container">
      <canvas id="sentimentChart" width="1600" height="400"></canvas>
    </div>
    <script>
      let chartInstance = null;
      let allData = [];
      let months = [];

      function renderChart(filteredData, monthLabel) {
        const labels = filteredData.map((item) => item.date);
        const positive = filteredData.map((item) => item.positive);
        const neutral = filteredData.map((item) => item.neutral);
        const negative = filteredData.map((item) => item.negative);

        // Set chart width dynamically based on data size
        const chartCanvas = document.getElementById("sentimentChart");
        chartCanvas.width = Math.max(1600, labels.length * 20);

        const ctx = chartCanvas.getContext("2d");
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Positive",
                data: positive,
                borderColor: "#0072B2", // blue (colorblind safe)
                backgroundColor: "rgba(0, 114, 178, 0.2)",
                fill: false,
                tension: 0.3,
                pointRadius: 2,
              },
              {
                label: "Neutral",
                data: neutral,
                borderColor: "#E69F00", // orange (colorblind safe)
                backgroundColor: "rgba(230, 159, 0, 0.2)",
                fill: false,
                tension: 0.3,
                pointRadius: 2,
              },
              {
                label: "Negative",
                data: negative,
                borderColor: "#009E73", // green (colorblind safe)
                backgroundColor: "rgba(0, 158, 115, 0.2)",
                fill: false,
                tension: 0.3,
                pointRadius: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: {
                  color: "#343a40",
                  font: {
                    size: 16,
                    family: "Helvetica Neue, Arial, sans-serif",
                    weight: "bold",
                  },
                },
              },
              title: {
                display: true,
                text: monthLabel
                  ? `Sentiment for ${monthLabel}`
                  : "Sentiment Statistics Per Month",
                font: { size: 18 },
              },
              zoom: {
                pan: {
                  enabled: true,
                  mode: 'x',
                },
                zoom: {
                  wheel: {
                    enabled: true,
                  },
                  pinch: {
                    enabled: true
                  },
                  mode: 'x',
                },
                limits: {
                  x: {min: 0, max: labels.length - 1}
                }
              }
            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: "Date",
                  color: "#343a40",
                  font: { size: 14 },
                },
                ticks: {
                  autoSkip: false,
                  maxRotation: 90,
                  minRotation: 45,
                },
              },
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Count",
                  color: "#343a40",
                  font: { size: 14 },
                },
              },
            },
          },
        });
        // Zoom into the latest month on initial view
        if (labels.length > 0) {
          const latestMonth = labels[labels.length - 1].slice(0, 7);
          const startIdx = labels.findIndex(l => l.slice(0, 7) === latestMonth);
          chartInstance.options.scales.x.min = startIdx;
          chartInstance.options.scales.x.max = labels.length - 1;
          chartInstance.update();
        }
      }

      function renderMonthButtons() {
        const filterDiv = document.getElementById("monthFilter");
        filterDiv.innerHTML = "";
        months.forEach((month) => {
          const btn = document.createElement("button");
          btn.textContent = month;
          btn.onclick = () => {
            document
              .querySelectorAll(".month-filter button")
              .forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            const filtered = allData.filter((item) =>
              item.date.startsWith(month)
            );
            renderChart(filtered, month);
          };
          filterDiv.appendChild(btn);
        });
        // Add 'All' button
        const allBtn = document.createElement("button");
        allBtn.textContent = "All";
        allBtn.classList.add("active");
        allBtn.onclick = () => {
          document
            .querySelectorAll(".month-filter button")
            .forEach((b) => b.classList.remove("active"));
          allBtn.classList.add("active");
          // Downsample data for 'All' view: show one point per week
          const weekData = [];
          let lastWeek = null;
          allData.forEach((item) => {
            const dateObj = new Date(item.date);
            const week = `${dateObj.getFullYear()}-W${Math.ceil(
              dateObj.getDate() / 7
            )}`;
            if (week !== lastWeek) {
              weekData.push(item);
              lastWeek = week;
            }
          });
          renderChart(weekData, "All Months (Weekly)");
        };
        filterDiv.insertBefore(allBtn, filterDiv.firstChild);
      }

      fetch("/api/dashboard/sentiment-stats/")
        .then((response) => response.json())
        .then((data) => {
          allData = data.map((item) => ({
            ...item,
            date: item.date, // keep full date for filtering
          }));
          months = [...new Set(data.map((item) => item.date.slice(0, 7)))];
          renderMonthButtons();
          renderChart(allData, "All Months");
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  </body>
</html>

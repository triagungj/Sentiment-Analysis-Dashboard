<!DOCTYPE html>
<html>
  <head>
    <title>Sentiment Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .month-filter {
        margin-bottom: 20px;
      }
      .month-filter button {
        margin-right: 8px;
        padding: 6px 16px;
        font-size: 15px;
        border-radius: 4px;
        border: 1px solid #ccc;
        background: #f8f9fa;
        cursor: pointer;
      }
      .month-filter button.active {
        background: #007bff;
        color: #fff;
        border-color: #007bff;
      }

      .chart-container {
        overflow-x: auto;
        width: 100%;
        min-height: 50vh;
      }
      #sentimentChart {
        height: 400px;
      }

      /* News list */
      .news-section {
        margin-top: 24px;
      }
      .news-item {
        display: flex;
        gap: 12px;
        padding: 12px 0;
        border-bottom: 1px solid #eee;
        align-items: flex-start;
      }
      .thumb {
        flex: 0 0 72px;
        width: 72px;
        height: 72px;
        border-radius: 8px;
        overflow: hidden;
        background: #f2f2f2;
        border: 1px solid #e9ecef;
      }
      .thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }
      .news-content {
        flex: 1;
        min-width: 0;
      }
      .news-item h4 {
        margin: 0 0 4px 0;
        font-size: 16px;
        line-height: 1.3;
      }
      .news-item a {
        text-decoration: none;
        color: #0d6efd;
      }
      .news-item a:hover {
        text-decoration: underline;
      }
      .news-meta {
        font-size: 12px;
        color: #6c757d;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
        border: 1px solid #ddd;
        margin-left: 6px;
        text-transform: capitalize;
      }
      .load-more {
        margin: 12px 0 0 0;
        padding: 8px 14px;
        border: 1px solid #ccc;
        border-radius: 6px;
        background: #fff;
        cursor: pointer;
      }
      .empty {
        color: #6c757d;
        font-style: italic;
        margin-top: 6px;
      }
    </style>
  </head>
  <body>
    <h2>Sentiment Statistics Per Month</h2>
    <div class="month-filter" id="monthFilter"></div>

    <div class="chart-container">
      <canvas id="sentimentChart" width="1600" height="400"></canvas>
    </div>

    <!-- News list -->
    <div class="news-section">
      <h3 id="newsTitle" style="margin-bottom: 8px">Latest News</h3>
      <div id="newsList"></div>
      <button id="loadMoreBtn" class="load-more" style="display: none">
        Load more
      </button>
    </div>

    <script>
      let chartInstance = null;
      let allData = [];
      let months = [];

      // pagination state
      let currentMonth = null; // null means "All"
      let nextPageUrl = null;

      // Tiny inline SVG placeholder (light gray)
      const PLACEHOLDER_SVG =
        "data:image/svg+xml;utf8," +
        encodeURIComponent(
          `<svg xmlns="http://www.w3.org/2000/svg" width="72" height="72">
          <rect width="100%" height="100%" fill="#f2f2f2"/>
          <path d="M10 52 L28 34 L40 46 L52 34 L62 44 L62 62 L10 62 Z" fill="#e0e0e0"/>
          <circle cx="22" cy="22" r="8" fill="#e5e5e5"/>
        </svg>`
        );

      function renderChart(filteredData, monthLabel) {
        const labels = filteredData.map((item) => item.date);
        const positive = filteredData.map((item) => item.positive);
        const neutral = filteredData.map((item) => item.neutral);
        const negative = filteredData.map((item) => item.negative);

        const chartCanvas = document.getElementById("sentimentChart");
        chartCanvas.width = Math.max(1600, labels.length * 20);

        const ctx = chartCanvas.getContext("2d");
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Positive",
                data: positive,
                borderColor: "#0072B2",
                backgroundColor: "rgba(0,114,178,0.2)",
                fill: false,
                tension: 0.3,
                pointRadius: 2,
              },
              {
                label: "Neutral",
                data: neutral,
                borderColor: "#E69F00",
                backgroundColor: "rgba(230,159,0,0.2)",
                fill: false,
                tension: 0.3,
                pointRadius: 2,
              },
              {
                label: "Negative",
                data: negative,
                borderColor: "#009E73",
                backgroundColor: "rgba(0,158,115,0.2)",
                fill: false,
                tension: 0.3,
                pointRadius: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                labels: {
                  color: "#343a40",
                  font: {
                    size: 16,
                    family: "Helvetica Neue, Arial, sans-serif",
                    weight: "bold",
                  },
                },
              },
              title: {
                display: true,
                text: monthLabel
                  ? `Sentiment for ${monthLabel}`
                  : "Sentiment Statistics Per Month",
                font: { size: 18 },
              },
              zoom: {
                pan: { enabled: true, mode: "x" },
                zoom: {
                  wheel: { enabled: true },
                  pinch: { enabled: true },
                  mode: "x",
                },
                limits: { x: { min: 0, max: labels.length - 1 } },
              },
            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: "Date",
                  color: "#343a40",
                  font: { size: 14 },
                },
                ticks: { autoSkip: false, maxRotation: 90, minRotation: 45 },
              },
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "Count",
                  color: "#343a40",
                  font: { size: 14 },
                },
              },
            },
          },
        });

        // Focus last month on initial render for non-empty data (except for the weekly "All" view)
        if (labels.length > 0 && monthLabel !== "All Months (Weekly)") {
          const latestMonth = labels[labels.length - 1].slice(0, 7);
          const startIdx = labels.findIndex(
            (l) => l.slice(0, 7) === latestMonth
          );
          chartInstance.options.scales.x.min = startIdx;
          chartInstance.options.scales.x.max = labels.length - 1;
          chartInstance.update();
        }
      }

      function renderNewsList(items, append = false) {
        const list = document.getElementById("newsList");
        const loadMoreBtn = document.getElementById("loadMoreBtn");
        if (!append) list.innerHTML = "";

        if (!items || items.length === 0) {
          if (!append)
            list.innerHTML = '<div class="empty">No news found.</div>';
          loadMoreBtn.style.display = "none";
          return;
        }

        const fragment = document.createDocumentFragment();
        items.forEach((n) => {
          const title = n.title || "Untitled";
          const url = n.url || n.link || "#";
          const date = n.published_at || n.created_at || n.date || "";
          const source = n.source?.name || n.source || "";
          const sentiment = n.sentiment || "";
          const imgSrc = n.image_link || PLACEHOLDER_SVG;

          const item = document.createElement("div");
          item.className = "news-item";

          const left = document.createElement("div");
          left.className = "thumb";
          left.innerHTML = `<img loading="lazy" src="${imgSrc}" alt="" onerror="this.onerror=null;this.src='${PLACEHOLDER_SVG}';">`;

          const right = document.createElement("div");
          right.className = "news-content";
          right.innerHTML = `
            <h4><a href="${url}" target="_blank" rel="noopener noreferrer">${title}</a></h4>
            <div class="news-meta">
              <span>${date ? new Date(date).toLocaleString() : ""}</span>
              ${source ? ` • <span>${source}</span>` : ""}
              ${sentiment ? ` <span class="badge">${sentiment}</span>` : ""}
            </div>
          `;

          item.appendChild(left);
          item.appendChild(right);
          fragment.appendChild(item);
        });
        list.appendChild(fragment);

        document.getElementById("loadMoreBtn").style.display = nextPageUrl
          ? "inline-block"
          : "none";
      }

      // Fetch news by month (uses your /api/news/?month=YYYY-MM)
      async function fetchNewsByMonth(
        month,
        urlOverride = null,
        append = false
      ) {
        const url =
          urlOverride || `/api/news/?month=${encodeURIComponent(month)}`;
        const res = await fetch(url);
        if (!res.ok) {
          console.error("Failed to fetch monthly news:", await res.text());
          renderNewsList([], append);
          return;
        }
        const data = await res.json();
        const items = Array.isArray(data) ? data : data.results;
        nextPageUrl = data.next || null;
        renderNewsList(items, append);
      }

      // Latest news (All filter)
      async function fetchLatestNews(urlOverride = null, append = false) {
        // backend already defaults to newest-first
        const url = urlOverride || `/api/news/`;
        const res = await fetch(url);
        if (!res.ok) {
          console.error("Failed to fetch latest news:", await res.text());
          renderNewsList([], append);
          return;
        }
        const data = await res.json();
        const items = Array.isArray(data) ? data : data.results;
        nextPageUrl = data.next || null;
        renderNewsList(items, append);
      }

      function renderMonthButtons() {
        const filterDiv = document.getElementById("monthFilter");
        filterDiv.innerHTML = "";

        months.forEach((month) => {
          const btn = document.createElement("button");
          btn.textContent = month;
          btn.onclick = async () => {
            document
              .querySelectorAll(".month-filter button")
              .forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");

            // Chart for that month
            const filtered = allData.filter((item) =>
              item.date.startsWith(month)
            );
            renderChart(filtered, month);

            // News for that month
            currentMonth = month;
            document.getElementById(
              "newsTitle"
            ).textContent = `News — ${month}`;
            nextPageUrl = null;
            await fetchNewsByMonth(month);
          };
          filterDiv.appendChild(btn);
        });

        // "All" button: show weekly chart + latest news (NEWEST FIRST)
        const allBtn = document.createElement("button");
        allBtn.textContent = "All";
        allBtn.classList.add("active");
        allBtn.onclick = async () => {
          document
            .querySelectorAll(".month-filter button")
            .forEach((b) => b.classList.remove("active"));
          allBtn.classList.add("active");

          // Weekly downsample for the chart
          const weekData = [];
          let lastWeek = null;
          allData.forEach((item) => {
            const dateObj = new Date(item.date);
            const week = `${dateObj.getFullYear()}-W${Math.ceil(
              dateObj.getDate() / 7
            )}`;
            if (week !== lastWeek) {
              weekData.push(item);
              lastWeek = week;
            }
          });
          renderChart(weekData, "All Months (Weekly)");

          // Show newest news
          currentMonth = null;
          nextPageUrl = null;
          document.getElementById("newsTitle").textContent = "Latest News";
          await fetchLatestNews();
        };
        filterDiv.insertBefore(allBtn, filterDiv.firstChild);
      }

      // Load more continues in the same mode
      document
        .getElementById("loadMoreBtn")
        .addEventListener("click", async () => {
          if (!nextPageUrl) return;
          if (currentMonth) {
            await fetchNewsByMonth(currentMonth, nextPageUrl, true);
          } else {
            await fetchLatestNews(nextPageUrl, true);
          }
        });

      // Initial bootstrap
      fetch("/api/dashboard/sentiment-stats/")
        .then((response) => response.json())
        .then(async (data) => {
          allData = data.map((item) => ({ ...item, date: item.date }));
          months = [...new Set(data.map((item) => item.date.slice(0, 7)))];
          renderMonthButtons();

          renderChart(allData, "All Months (Weekly)");
          document.getElementById("newsTitle").textContent = "Latest News";
          await fetchLatestNews();
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
  </body>
</html>
